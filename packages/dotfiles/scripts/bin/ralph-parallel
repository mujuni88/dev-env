#!/bin/bash
# ralph-parallel - Parallel autonomous task execution using git worktrees
#
# Usage: ralph-parallel [OPTIONS]
#
# Options:
#   -w, --workers N      Number of parallel workers (default: 2)
#   -b, --base-branch B  Base branch to create worktrees from (default: current branch)
#   --cleanup            Remove all worktrees and exit
#   --idle-sleep N       Seconds to sleep when idle (default: 60)
#   -h, --help           Show this help message
#
# Prerequisites:
#   - Git repository with beads initialized
#   - mprocs installed (for monitoring)
#   - prompt.md in the repository root
#
# Each worker:
#   1. Gets its own git worktree (project-worker-N)
#   2. Claims tasks atomically via beads
#   3. Runs the standard ralph loop
#   4. Creates commits on its own branch

set -e

# Defaults
NUM_WORKERS=2
BASE_BRANCH=""
IDLE_SLEEP=60
CLEANUP_ONLY=false

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -w|--workers) NUM_WORKERS="$2"; shift 2 ;;
    -b|--base-branch) BASE_BRANCH="$2"; shift 2 ;;
    --cleanup) CLEANUP_ONLY=true; shift ;;
    --idle-sleep) IDLE_SLEEP="$2"; shift 2 ;;
    -h|--help) head -n 20 "$0" | tail -n +2 | sed 's/^# //'; exit 0 ;;
    *) echo "Unknown option: $1" >&2; exit 1 ;;
  esac
done

# Get project info
PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || {
  echo "Error: Not in a git repository" >&2
  exit 1
}
PROJECT_NAME=$(basename "$PROJECT_ROOT")
WORKTREE_BASE=$(dirname "$PROJECT_ROOT")

# Use current branch if not specified
if [ -z "$BASE_BRANCH" ]; then
  BASE_BRANCH=$(git rev-parse --abbrev-ref HEAD)
fi

log() { echo "[ralph-parallel] $*"; }

cleanup_worktrees() {
  log "Cleaning up worktrees..."
  for i in $(seq 1 "$NUM_WORKERS"); do
    worktree_path="$WORKTREE_BASE/${PROJECT_NAME}-worker-$i"
    if [ -d "$worktree_path" ]; then
      log "Removing worktree: $worktree_path"
      git worktree remove "$worktree_path" --force 2>/dev/null || rm -rf "$worktree_path"
    fi
    # Clean up the branch too
    git branch -D "worker-$i" 2>/dev/null || true
  done
  log "Cleanup complete"
}

if [ "$CLEANUP_ONLY" = true ]; then
  cleanup_worktrees
  exit 0
fi

# Validate prerequisites
if ! command -v mprocs &>/dev/null; then
  echo "Error: mprocs not installed. Install with: brew install mprocs" >&2
  exit 1
fi

if ! bd info --json &>/dev/null; then
  echo "Error: beads not initialized in this repository" >&2
  echo "Run: bd init" >&2
  exit 1
fi

if [ ! -f "$PROJECT_ROOT/prompt.md" ]; then
  echo "Error: prompt.md not found in $PROJECT_ROOT" >&2
  exit 1
fi

log "Project: $PROJECT_NAME"
log "Base branch: $BASE_BRANCH"
log "Workers: $NUM_WORKERS"
log "Worktree base: $WORKTREE_BASE"

# Setup worktrees
log "Setting up worktrees..."
for i in $(seq 1 "$NUM_WORKERS"); do
  worktree_path="$WORKTREE_BASE/${PROJECT_NAME}-worker-$i"
  branch_name="worker-$i"

  if [ -d "$worktree_path" ]; then
    log "Worktree $i already exists at $worktree_path"
  else
    log "Creating worktree $i: $worktree_path (branch: $branch_name)"
    git worktree add "$worktree_path" -b "$branch_name" "$BASE_BRANCH" 2>/dev/null || \
    git worktree add "$worktree_path" "$branch_name" 2>/dev/null || {
      echo "Failed to create worktree $i" >&2
      exit 1
    }
  fi
done

# Build mprocs command
log "Starting workers with mprocs..."
WORKER_NAMES=""
WORKER_CMDS=()

for i in $(seq 1 "$NUM_WORKERS"); do
  worktree_path="$WORKTREE_BASE/${PROJECT_NAME}-worker-$i"
  if [ -n "$WORKER_NAMES" ]; then
    WORKER_NAMES="$WORKER_NAMES,"
  fi
  WORKER_NAMES="${WORKER_NAMES}worker-$i"
  WORKER_CMDS+=("cd '$worktree_path' && RALPH_WORKER_ID=$i ralph --idle-sleep $IDLE_SLEEP")
done

# Run with mprocs
exec mprocs --names "$WORKER_NAMES" "${WORKER_CMDS[@]}"
